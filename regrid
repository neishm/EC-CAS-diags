#!/usr/bin/env python

from eccas_diags import interfaces

import argparse

# Custom action for collecting input arguments
class set_dictkey(argparse.Action):
  def __init__ (self, option_strings, dest, nargs=None, const=None, default={}, type=None, choices=None, required=False, help=None, metavar=None):
    super(set_dictkey, self).__init__ (option_strings, dest, nargs, const, default, type, choices, required, help, metavar)
  def __call__ (self, parser, namespace, values, option_string=None):
    setattr(namespace, self.dest+'_last_key', values)
class append_dictvalue(argparse.Action):
  def __call__ (self, parser, namespace, values, option_string=None):
    key = getattr(namespace, self.dest+'_last_key',None)
    d = getattr(namespace, self.dest)
    d.setdefault(key,[])
    if isinstance(values,list):
      d[key].extend(values)
    else:
      d[key].append(values)

# Parse the command-line arguments

valid_types = interfaces.table.keys()

parser = argparse.ArgumentParser(description="Converts model data from one format to another.", epilog="TYPE can be: "+', '.join(valid_types))
parser.add_argument ("--intype", help="The type of input data to read.", choices=valid_types, required=True, action=set_dictkey, metavar="TYPE", dest="input")
parser.add_argument ("--infiles", help="The input file(s), or an input directory.", nargs='+', required=True, action=append_dictvalue, metavar="FILE", dest="input")
parser.add_argument ("--outtype", help="The type of output data to write.", choices=valid_types, required=True, metavar="TYPE")
parser.add_argument ("--gridfiles", help="File(s) or directory that contains the target grid to convert the data to.  Should be in the same format as the output.", nargs='+', required=True, metavar="FILE")
parser.add_argument ("--outdir", help="The directory to write the output files.", required=True)
parser.add_argument ("--use-target-time", help="Treat the input data as being valid at the first time in the target grid file.  Useful for generating initial conditions with data that comes from a different time period.", action="store_true")
group = parser.add_mutually_exclusive_group()
group.add_argument ("--conserve-mass", help="Does a mass-conservative regridding. (default)", action="store_const", const=True, default=True, dest="conserve_mass")
group.add_argument("--no-conserve-mass", help="Does a non-conservative interpolation of the fields.", action="store_const", const=False, dest="conserve_mass")
parser.add_argument ("--debug", help="Print debugging messages.  Also, dump the full stack trace when there's an error.", action="store_true")

args = parser.parse_args()

# Try doing something
# Fail gracefully if there's a problem

import logging
if args.debug:
  logging.basicConfig(level=logging.DEBUG)
else:
  logging.basicConfig(level=logging.INFO)

try:

  # Get the target grid
  grid_data = interfaces.table[args.outtype](args.gridfiles)

  # Collect all the input data for various sources
  from eccas_diags.interfaces import DataInterface
  input_data = []
  for intype, infiles in args.input.iteritems():
    if intype is None: raise ValueError("No type specified for files %s"%infiles)
    input_data.extend(interfaces.table[intype](infiles))

  # Force the input data to be valid at the target grid time?
  if args.use_target_time:
    gridtime = grid_data.datasets[0].time(i_time=0)
    logging.info("Forcing time: %s", gridtime)
    for i, dataset in enumerate(input_data):
      dataset = dataset(i_time=0)
      dataset = dataset.replace_axes(time=gridtime)
      input_data[i] = dataset


  input_data = DataInterface(input_data)

  # Get the output interface
  out_interface = interfaces.table[args.outtype]

  data = input_data

  # Vertical regridding (keeping source surface pressure)
  from eccas_diags.regrid_vert_wrapper import do_vertical_regridding, do_vertical_interpolation
  if args.conserve_mass:
    data = do_vertical_regridding (data, grid_data)
  else:
    data = do_vertical_interpolation (data, grid_data)

  # Horizontal regridding
  from eccas_diags.regrid_horz_wrapper import do_horizontal_regridding
  data = do_horizontal_regridding (data, grid_data)

  # Apply a global adjustment to conserve mass
  from eccas_diags.regrid_fix_mass import global_scale
  if args.conserve_mass:
    data = global_scale (data, input_data, grid_data)

  # Write the data out.
  out_interface.write(data, args.outdir)

except Exception as e:
  from sys import exit
  if args.debug: raise
  print "Error: %s"%e
  exit(1)

